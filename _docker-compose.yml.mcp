version: "3.9"

services:
  dev:
    build:
      context: .devcontainer
      dockerfile: Dockerfile
    volumes:
      - .:/workspace:cached
      - /var/run/docker.sock:/var/run/docker.sock
    working_dir: /workspace
    tty: true
    stdin_open: true
    environment:
      - PIP_DISABLE_PIP_VERSION_CHECK=1
    command: bash -lc "sleep infinity"

  # Base cache/queue that many PoCs want
  redis:
    image: redis:7
    ports:
      - "6379:6379"

  # -------- RAG profile --------
  qdrant:
    image: qdrant/qdrant:latest
    profiles: ["rag"]
    ports:
      - "6333:6333"
    volumes:
      - qdrant_data:/qdrant/storage

  ollama:
    image: ollama/ollama:latest
    profiles: ["rag"]
    ports:
      - "11434:11434"
    volumes:
      - ollama:/root/.ollama
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11434/api/tags"]
      interval: 10s
      timeout: 5s
      retries: 10

  api:
    build:
      context: services/api
      dockerfile: Dockerfile
    profiles: ["rag"]
    environment:
      # provider 切到 ollama（也保留 OPENAI 变量，随时可切回）
      - PROVIDER=${PROVIDER:-ollama}
      - OLLAMA_HOST=ollama
      - OLLAMA_PORT=11434
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-nomic-embed-text}
      - CHAT_MODEL=${CHAT_MODEL:-llama3.2:3b}
      # 如需继续用 OpenAI，只需把 PROVIDER=openai 并提供 OPENAI_API_KEY
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
    depends_on:
      - qdrant
      - ollama
    ports:
      - "8000:8000"
    volumes:
      - ./data/docs:/data/docs:ro

  # -------- MCP profile --------
  mcpgateway:
    image: ghcr.io/ibm/mcp-context-forge:0.6.0
    container_name: mcpgateway
    profiles: ["mcp"]
    ports:
      - "4444:4444"
    environment:
      MCPGATEWAY_UI_ENABLED: "true"
      MCPGATEWAY_ADMIN_API_ENABLED: "true"
      HOST: "0.0.0.0"
      PORT: "4444"
      # --- Auth ---
      BASIC_AUTH_USER: "${MCP_ADMIN_USER:-admin}"
      BASIC_AUTH_PASSWORD: "${MCP_ADMIN_PASS:-changeme}"
      AUTH_REQUIRED: "true"
      JWT_SECRET_KEY: "${MCP_JWT_SECRET:-please-change-me}"
      # --- DB ---
      DATABASE_URL: "sqlite:////data/mcp.db"
      # --- Optional: enable basic OTEL traces to Phoenix/Jaeger/etc if you have it
      # OTEL_ENABLE_OBSERVABILITY: "false"
      # OTEL_TRACES_EXPORTER: "otlp"
      # OTEL_EXPORTER_OTLP_ENDPOINT: "http://host.docker.internal:4317"
    volumes:
      - ./data/mcp:/data
    # Helpful on macOS/Windows for reaching host services; harmless on Linux
    extra_hosts:
      - "host.docker.internal:host-gateway"

volumes:
  qdrant_data:
  ollama:
